<!DOCTYPE HTML>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="Keywords" content="blog"/>
    <meta name="Description" content="blog"/>
    <title>Simple</title>
    <link rel="shortcut icon" href="/static/favicon.png"/>
    <link rel="stylesheet" type="text/css" href="/main.css" />
</head>
<body>
<div class="main">
    <div class="header">
    	<ul id="pages">
            <li><a href="/">home</a></li>
            <li><a href="/#/tags">tags</a></li>
            <li><a href="/#/archive">archive</a></li>
    	</ul>
    </div>
	<div class="wrap-header">
    <h1>
    <a href="/" id="title"></a>
    </h1>
	</div>
<xmp id="md" style="display: none;">
<!-- markdown -->
PowerView 是基于 PowerShell 的域渗透信息收集脚本, 该脚本完全通过 PowerShell, WMI 和 Win32 API 的方式实现诸如 net 等一系列命令以达到躲避检测的效果.

PowerView 脚本大体可分为 Misc Domain GPO Enum Meta Trust 六类.

限于篇幅原因, 仅对常用脚本进行说明.

## Misc

**Export-PowerViewCSV**

将 PowerView 输出导出为 CSV 格式.

```
Get-DomainUser | Export-PowerViewCSV -Path C:\Windows\Temp\out.csv
```

**Resolve-IPAddress**

将主机名解析为 IP.

```
Resolve-IPAddress -ComputerName DC
```

**ConvertTo-SID**

将用户名/组名转换为 SID.

```
ConvertTo-SID TEST\Administrator
```

**Get-DomainSPNTicket**

请求指定 SPN 的 Kerberos 票据.

```
Get-DomainSPNTicket -SPN MSSQLSvc/DC.test.com
```

**Invoke-Kerberoast**

提取请求的 Kerberos 票据中的 Hash.

```
Invoke-Kerberoast | fl
```

**Get-PathACL**

返回指定文件路径的 ACL.

```
Get-PathACL .\Documents
```

## Domain

**Get-DomainDNSZone**

返回指定域的 DNS 区域.

```
Get-DomainDNSZone
```

**Get-DomainDNSRecord**

返回指定域的 DNS 记录.

```
Get-DomainDNSRecord -ZoneName test.com | Select Name
```

**Get-Domain**

返回当前域的信息.

```
Get-Domain
```

**Get-DomainController**

返回当前域的域控制器.

```
Get-DomainController
```

**Get-Forest**

返回当前域林的信息.

```
Get-Forest
```

**Get-ForestDomain**

返回域林中的所有域.

```
Get-ForestDomain
```

**Get-DomainUser**

返回当前域的所有用户.

```
Get-DomainUser | Select SAMAccountName
```

**New-DomainUser**

在当前域中新建用户.

```
$Password = ConvertTo-SecureString '123456' -AsPlainText -Force
New-DomainUser -SamAccountName test -AccountPassword $Password
```

**Set-DomainUserPassword**

更改域中用户的密码.

```
$Password = ConvertTo-SecureString '123456' -AsPlainText -Force
Set-DomainUserPassword -Identity test -AccountPassword $Password
```

**Get-DomainUserEvent**

枚举用户登录事件.

```
Get-DomainUserEvent
```

**Get-DomainComputer**

返回当前域中的所有计算机.

```
Get-DomainComputer | Select name
```

**Get-DomainSID**

返回当前域的 SID.

```
Get-DomainSID
```

**Get-DomainGroup**

返回当前域的所有组.

```
Get-DomainGroup | Select SAMAccountName
```

**New-DomainGroup**

在当前域中新建组.

```
New-DomainGroup -SamAccountName TestGroup
```

**Get-DomainGroupMember**

返回指定域组的成员.

```
Get-DomainGroupMember "Domain Admins"
```

**Add-DomainGroupMember**

将域用户添加到指定域组.

```
Add-DomainGroupMember -Identity "Domain Admins" -Members "Administrator"
```

## GPO

**Get-DomainGPO**

返回域内所有组策略.

```
Get-DomainGPO | Select DisplayName
```

**Get-DomainPolicy**

返回当前域使用的组策略.

```
Get-DomainPolicy
```

## Enum

**Get-NetLocalGroup**

返回计算机上的所有本地组.

```
Get-NetLocalGroup
```

**Get-NetLocalGroupMember**

返回计算机上指定本地组的所有成员.

```
Get-NetLocalGroupMember -GroupName Administrators
```

**Get-NetShare**

返回计算机上的开放共享.

```
Get-NetShare
```

**Get-NetLoggedOn**

返回计算机上已登录的用户.

```
Get-NetLoggedOn
```

**Get-NetSession**

返回计算机上的会话信息.

```
Get-NetSession
```

**Get-WMIRegProxy**

返回当前用户的代理信息.

```
Get-WMIRegProxy
```

**Get-WMIRegLastLoggedOn**

返回登录计算机的最后一个用户.

```
Get-WMIRegLastLoggedOn
```

**Get-WMIRegCachedRDPConnection**

返回计算机上缓存的 RDP 连接信息.

```
Get-WMIRegCachedRDPConnection
```

**Get-WMIRegMountedDrive**

返回计算机上映射的网络驱动器.

```
Get-WMIRegMountedDrive
```

**Get-WMIProcess**

返回计算机上正在运行的进程.

```
Get-WMIProcess
```

**Find-InterestingFile**

搜索计算机上的敏感文件.

```
Find-InterestingFile
```

## Meta

**Find-DomainUserLocation**

查找特定用户登录的计算机.

```
Find-DomainUserLocation -UserIdentity test
```

**Find-DomainProcess**

查找运行特定进程的计算机.

```
Find-DomainProcess -ProcessName powershell.exe
```

**Find-DomainUserEvent**

查找特定用户的登录事件.

```
Find-DomainUserEvent -UserIdentity test
```

**Find-DomainShare**

查找域内开放的共享.

```
Find-DomainShare
```

**Find-DomainLocalGroupMember**

枚举域内计算机上指定本地组的成员.

```
Find-DomainLocalGroupMember -ComputerName TEST -GroupName Administrators
```

## Trust

**Get-DomainTrust**

返回当前域的所有域信任.

```
Get-DomainTrust
```

**Get-ForestTrust**

返回当前林的所有林信任

```
Get-ForestTrust
```

**Get-DomainTrustMapping**

枚举当前域的所有域信任, 然后枚举它找到的每个域的所有信任.

```
Get-DomainTrustMapping
```

## 注意

格式不止以上几种, 凭借其强大的管道, 可任意组合命令.
<!-- markdown end -->
</xmp>
<div class="entry" id="main">
<!-- content -->
<p>PowerView 是基于 PowerShell 的域渗透信息收集脚本, 该脚本完全通过 PowerShell, WMI 和 Win32 API 的方式实现诸如 net 等一系列命令以达到躲避检测的效果.</p>

<p>PowerView 脚本大体可分为 Misc Domain GPO Enum Meta Trust 六类.</p>

<p>限于篇幅原因, 仅对常用脚本进行说明.</p>

<h2 id="misc">Misc</h2>

<p><strong>Export-PowerViewCSV</strong></p>

<p>将 PowerView 输出导出为 CSV 格式.</p>

<pre><code>Get-DomainUser | Export-PowerViewCSV -Path C:\Windows\Temp\out.csv
</code></pre>

<p><strong>Resolve-IPAddress</strong></p>

<p>将主机名解析为 IP.</p>

<pre><code>Resolve-IPAddress -ComputerName DC
</code></pre>

<p><strong>ConvertTo-SID</strong></p>

<p>将用户名/组名转换为 SID.</p>

<pre><code>ConvertTo-SID TEST\Administrator
</code></pre>

<p><strong>Get-DomainSPNTicket</strong></p>

<p>请求指定 SPN 的 Kerberos 票据.</p>

<pre><code>Get-DomainSPNTicket -SPN MSSQLSvc/DC.test.com
</code></pre>

<p><strong>Invoke-Kerberoast</strong></p>

<p>提取请求的 Kerberos 票据中的 Hash.</p>

<pre><code>Invoke-Kerberoast | fl
</code></pre>

<p><strong>Get-PathACL</strong></p>

<p>返回指定文件路径的 ACL.</p>

<pre><code>Get-PathACL .\Documents
</code></pre>

<h2 id="domain">Domain</h2>

<p><strong>Get-DomainDNSZone</strong></p>

<p>返回指定域的 DNS 区域.</p>

<pre><code>Get-DomainDNSZone
</code></pre>

<p><strong>Get-DomainDNSRecord</strong></p>

<p>返回指定域的 DNS 记录.</p>

<pre><code>Get-DomainDNSRecord -ZoneName test.com | Select Name
</code></pre>

<p><strong>Get-Domain</strong></p>

<p>返回当前域的信息.</p>

<pre><code>Get-Domain
</code></pre>

<p><strong>Get-DomainController</strong></p>

<p>返回当前域的域控制器.</p>

<pre><code>Get-DomainController
</code></pre>

<p><strong>Get-Forest</strong></p>

<p>返回当前域林的信息.</p>

<pre><code>Get-Forest
</code></pre>

<p><strong>Get-ForestDomain</strong></p>

<p>返回域林中的所有域.</p>

<pre><code>Get-ForestDomain
</code></pre>

<p><strong>Get-DomainUser</strong></p>

<p>返回当前域的所有用户.</p>

<pre><code>Get-DomainUser | Select SAMAccountName
</code></pre>

<p><strong>New-DomainUser</strong></p>

<p>在当前域中新建用户.</p>

<pre><code>$Password = ConvertTo-SecureString '123456' -AsPlainText -Force
New-DomainUser -SamAccountName test -AccountPassword $Password
</code></pre>

<p><strong>Set-DomainUserPassword</strong></p>

<p>更改域中用户的密码.</p>

<pre><code>$Password = ConvertTo-SecureString '123456' -AsPlainText -Force
Set-DomainUserPassword -Identity test -AccountPassword $Password
</code></pre>

<p><strong>Get-DomainUserEvent</strong></p>

<p>枚举用户登录事件.</p>

<pre><code>Get-DomainUserEvent
</code></pre>

<p><strong>Get-DomainComputer</strong></p>

<p>返回当前域中的所有计算机.</p>

<pre><code>Get-DomainComputer | Select name
</code></pre>

<p><strong>Get-DomainSID</strong></p>

<p>返回当前域的 SID.</p>

<pre><code>Get-DomainSID
</code></pre>

<p><strong>Get-DomainGroup</strong></p>

<p>返回当前域的所有组.</p>

<pre><code>Get-DomainGroup | Select SAMAccountName
</code></pre>

<p><strong>New-DomainGroup</strong></p>

<p>在当前域中新建组.</p>

<pre><code>New-DomainGroup -SamAccountName TestGroup
</code></pre>

<p><strong>Get-DomainGroupMember</strong></p>

<p>返回指定域组的成员.</p>

<pre><code>Get-DomainGroupMember "Domain Admins"
</code></pre>

<p><strong>Add-DomainGroupMember</strong></p>

<p>将域用户添加到指定域组.</p>

<pre><code>Add-DomainGroupMember -Identity "Domain Admins" -Members "Administrator"
</code></pre>

<h2 id="gpo">GPO</h2>

<p><strong>Get-DomainGPO</strong></p>

<p>返回域内所有组策略.</p>

<pre><code>Get-DomainGPO | Select DisplayName
</code></pre>

<p><strong>Get-DomainPolicy</strong></p>

<p>返回当前域使用的组策略.</p>

<pre><code>Get-DomainPolicy
</code></pre>

<h2 id="enum">Enum</h2>

<p><strong>Get-NetLocalGroup</strong></p>

<p>返回计算机上的所有本地组.</p>

<pre><code>Get-NetLocalGroup
</code></pre>

<p><strong>Get-NetLocalGroupMember</strong></p>

<p>返回计算机上指定本地组的所有成员.</p>

<pre><code>Get-NetLocalGroupMember -GroupName Administrators
</code></pre>

<p><strong>Get-NetShare</strong></p>

<p>返回计算机上的开放共享.</p>

<pre><code>Get-NetShare
</code></pre>

<p><strong>Get-NetLoggedOn</strong></p>

<p>返回计算机上已登录的用户.</p>

<pre><code>Get-NetLoggedOn
</code></pre>

<p><strong>Get-NetSession</strong></p>

<p>返回计算机上的会话信息.</p>

<pre><code>Get-NetSession
</code></pre>

<p><strong>Get-WMIRegProxy</strong></p>

<p>返回当前用户的代理信息.</p>

<pre><code>Get-WMIRegProxy
</code></pre>

<p><strong>Get-WMIRegLastLoggedOn</strong></p>

<p>返回登录计算机的最后一个用户.</p>

<pre><code>Get-WMIRegLastLoggedOn
</code></pre>

<p><strong>Get-WMIRegCachedRDPConnection</strong></p>

<p>返回计算机上缓存的 RDP 连接信息.</p>

<pre><code>Get-WMIRegCachedRDPConnection
</code></pre>

<p><strong>Get-WMIRegMountedDrive</strong></p>

<p>返回计算机上映射的网络驱动器.</p>

<pre><code>Get-WMIRegMountedDrive
</code></pre>

<p><strong>Get-WMIProcess</strong></p>

<p>返回计算机上正在运行的进程.</p>

<pre><code>Get-WMIProcess
</code></pre>

<p><strong>Find-InterestingFile</strong></p>

<p>搜索计算机上的敏感文件.</p>

<pre><code>Find-InterestingFile
</code></pre>

<h2 id="meta">Meta</h2>

<p><strong>Find-DomainUserLocation</strong></p>

<p>查找特定用户登录的计算机.</p>

<pre><code>Find-DomainUserLocation -UserIdentity test
</code></pre>

<p><strong>Find-DomainProcess</strong></p>

<p>查找运行特定进程的计算机.</p>

<pre><code>Find-DomainProcess -ProcessName powershell.exe
</code></pre>

<p><strong>Find-DomainUserEvent</strong></p>

<p>查找特定用户的登录事件.</p>

<pre><code>Find-DomainUserEvent -UserIdentity test
</code></pre>

<p><strong>Find-DomainShare</strong></p>

<p>查找域内开放的共享.</p>

<pre><code>Find-DomainShare
</code></pre>

<p><strong>Find-DomainLocalGroupMember</strong></p>

<p>枚举域内计算机上指定本地组的成员.</p>

<pre><code>Find-DomainLocalGroupMember -ComputerName TEST -GroupName Administrators
</code></pre>

<h2 id="trust">Trust</h2>

<p><strong>Get-DomainTrust</strong></p>

<p>返回当前域的所有域信任.</p>

<pre><code>Get-DomainTrust
</code></pre>

<p><strong>Get-ForestTrust</strong></p>

<p>返回当前林的所有林信任</p>

<pre><code>Get-ForestTrust
</code></pre>

<p><strong>Get-DomainTrustMapping</strong></p>

<p>枚举当前域的所有域信任, 然后枚举它找到的每个域的所有信任.</p>

<pre><code>Get-DomainTrustMapping
</code></pre>

<h2 id="">注意</h2>

<p>格式不止以上几种, 凭借其强大的管道, 可任意组合命令.</p>
<!-- content end -->
</div>
<br>
<br>
    <div id="disqus_thread"></div>
	<div class="footer">
		<p>© Copyright 2017-2019 by X1r0z</p>
	</div>
</div>
<script src="main.js"></script>
<script id="content" type="text/mustache">
    <h1>{{title}}</h1>
    <div class="tag">
    {{date}}
    {{#tags}}
    <a href="/#/tag/{{name}}">#{{name}}</a>
    {{/tags}}
    </div>
</script>
<script id="pagesTemplate" type="text/mustache">
    {{#pages}}
    <li>
        <a href="{{path}}">{{title}}</a>
    </li>
    {{/pages}}
</script>
<script>
$(document).ready(function() {
    $.ajax({
        url: "main.json",
        type: "GET",
        dataType: "json",
        success: function(data) {
            $("#title").html(data.name);
            var pagesTemplate = Hogan.compile($("#pagesTemplate").html());
            var pagesHtml = pagesTemplate.render({"pages": data.pages});
            $("#pages").append(pagesHtml);
            //path
            var path = "powerview-domain-recon.html";
            //path end
            var now = 0;
            for (var i = 0; i < data.posts.length; ++i)
                if (path == data.posts[i].path)
                    now = i;
            var post = data.posts[now];
            var tmp = post.tags.split(" ");
            var tags = [];
            for (var i = 0; i < tmp.length; ++i)
                if (tmp[i].length > 0)
                    tags.push({"name": tmp[i]});
            var contentTemplate = Hogan.compile($("#content").html());
            var contentHtml = contentTemplate.render({"title": post.title, "tags": tags, "date": post.date});
            $("#main").prepend(contentHtml);
            if (data.disqus_shortname.length > 0) {
                var disqus_shortname = data.disqus_shortname;
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            }
        }
    });
});
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ["\\(", "\\)"]], processEscapes: true}});
</script>
</body>
</html>
